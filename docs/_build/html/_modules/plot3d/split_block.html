<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>plot3d.split_block &#8212; Plot3D 1.6.8 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/classic.css?v=def86cc0" />
    
    <script src="../../_static/documentation_options.js?v=514bbfa0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Plot3D 1.6.8 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">plot3d.split_block</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for plot3d.split_block</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Split blocks is combination of help from Dave Rigby and Tim Beach </span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.face</span><span class="w"> </span><span class="kn">import</span> <span class="n">Face</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.block</span><span class="w"> </span><span class="kn">import</span> <span class="n">Block</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">math</span><span class="w"> </span><span class="kn">import</span> <span class="n">gcd</span><span class="p">,</span> <span class="n">sqrt</span> 
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span> 

<div class="viewcode-block" id="Direction">
<a class="viewcode-back" href="../../modules/split_block.html#plot3d.split_block.Direction">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Direction</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">k</span> <span class="o">=</span> <span class="mi">2</span></div>


<div class="viewcode-block" id="max_aspect_ratio">
<a class="viewcode-back" href="../../modules/split_block.html#plot3d.split_block.max_aspect_ratio">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">max_aspect_ratio</span><span class="p">(</span><span class="n">X</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span><span class="n">Y</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span><span class="n">Z</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span><span class="n">ix</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span><span class="n">jx</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span><span class="n">kx</span><span class="p">:</span><span class="nb">int</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Finds the maximum cell aspect ratio</span>

<span class="sd">    Args:</span>
<span class="sd">        X (np.ndarray): 3 dimensional Array containing X values. X[i,j,k]</span>
<span class="sd">        Y (np.ndarray): 3 dimensional Array containing X values. X[i,j,k]</span>
<span class="sd">        Z (np.ndarray): 3 dimensional Array containing X values. X[i,j,k]</span>

<span class="sd">    Returns:</span>
<span class="sd">        float: Maximum value of aspect ratio </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">[</span><span class="n">ix</span><span class="p">,</span><span class="n">jx</span><span class="p">,</span><span class="n">kx</span><span class="p">]</span>  <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span> <span class="c1"># ix, jx, kx are the max values like IMAX, JMAX, KMAX</span>
    <span class="n">ix</span><span class="o">-=</span><span class="mi">1</span><span class="p">;</span> <span class="n">jx</span><span class="o">-=</span><span class="mi">1</span><span class="p">;</span> <span class="n">kx</span><span class="o">-=</span><span class="mi">1</span> <span class="c1"># Python is 0 index so need to subtract 1 from ix, iy, kx to reference the last value </span>

    <span class="c1"># Each column is a corner </span>
    <span class="c1"># [corner 1, corner 2, corner 3, corner 4]</span>
    <span class="n">i1</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> 
    <span class="n">j1</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">jx</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">k1</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">kx</span><span class="p">]</span>

    <span class="c1"># Appending more corners []</span>
    <span class="n">i1</span> <span class="o">=</span> <span class="n">i1</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ix</span><span class="p">,</span><span class="n">ix</span><span class="p">,</span><span class="n">ix</span><span class="p">]</span>
    <span class="n">j1</span> <span class="o">=</span> <span class="n">j1</span> <span class="o">+</span> <span class="p">[</span><span class="n">jx</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">jx</span><span class="p">,</span><span class="n">jx</span><span class="p">]</span>
    <span class="n">k1</span> <span class="o">=</span> <span class="n">k1</span> <span class="o">+</span> <span class="p">[</span><span class="n">kx</span><span class="p">,</span><span class="n">kx</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">kx</span><span class="p">]</span>

    <span class="c1"># i2, j2, k2 are the first nodes diagonally from the block corners </span>
    <span class="n">i2</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">ix</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">j2</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">jx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">k2</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">i2</span> <span class="o">=</span> <span class="n">i2</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">ix</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ix</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ix</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">j2</span> <span class="o">=</span> <span class="n">j2</span> <span class="o">+</span> <span class="p">[</span><span class="n">jx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">jx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">jx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">k2</span> <span class="o">=</span> <span class="n">k2</span> <span class="o">+</span> <span class="p">[</span><span class="n">kx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">kx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="n">ds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">i2</span><span class="p">)):</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sqrt</span><span class="p">((</span><span class="n">X</span><span class="p">(</span><span class="n">i2</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="n">j1</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="n">k1</span><span class="p">[</span><span class="n">n</span><span class="p">])</span><span class="o">-</span><span class="n">X</span><span class="p">(</span><span class="n">i1</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="n">j1</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="n">k1</span><span class="p">[</span><span class="n">n</span><span class="p">]))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                    <span class="p">(</span><span class="n">Y</span><span class="p">(</span><span class="n">i2</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="n">j1</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="n">k1</span><span class="p">[</span><span class="n">n</span><span class="p">])</span><span class="o">-</span><span class="n">Y</span><span class="p">(</span><span class="n">i1</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="n">j1</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="n">k1</span><span class="p">[</span><span class="n">n</span><span class="p">]))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>  
                    <span class="p">(</span><span class="n">Z</span><span class="p">(</span><span class="n">i2</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="n">j1</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="n">k1</span><span class="p">[</span><span class="n">n</span><span class="p">])</span><span class="o">-</span><span class="n">Z</span><span class="p">(</span><span class="n">i1</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="n">j1</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="n">k1</span><span class="p">[</span><span class="n">n</span><span class="p">]))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="p">)</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sqrt</span><span class="p">((</span><span class="n">X</span><span class="p">(</span><span class="n">i1</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="n">j2</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="n">k1</span><span class="p">[</span><span class="n">n</span><span class="p">])</span><span class="o">-</span><span class="n">X</span><span class="p">(</span><span class="n">i1</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="n">j1</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="n">k1</span><span class="p">[</span><span class="n">n</span><span class="p">]))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>  
                    <span class="p">(</span><span class="n">Y</span><span class="p">(</span><span class="n">i1</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="n">j2</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="n">k1</span><span class="p">[</span><span class="n">n</span><span class="p">])</span><span class="o">-</span><span class="n">Y</span><span class="p">(</span><span class="n">i1</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="n">j1</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="n">k1</span><span class="p">[</span><span class="n">n</span><span class="p">]))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>  
                    <span class="p">(</span><span class="n">Z</span><span class="p">(</span><span class="n">i1</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="n">j2</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="n">k1</span><span class="p">[</span><span class="n">n</span><span class="p">])</span><span class="o">-</span><span class="n">Z</span><span class="p">(</span><span class="n">i1</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="n">j1</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="n">k1</span><span class="p">[</span><span class="n">n</span><span class="p">]))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="p">)</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sqrt</span><span class="p">((</span><span class="n">X</span><span class="p">(</span><span class="n">i1</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="n">j1</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="n">k2</span><span class="p">[</span><span class="n">n</span><span class="p">])</span><span class="o">-</span><span class="n">X</span><span class="p">(</span><span class="n">i1</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="n">j1</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="n">k1</span><span class="p">[</span><span class="n">n</span><span class="p">]))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> 
                    <span class="p">(</span><span class="n">Y</span><span class="p">(</span><span class="n">i1</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="n">j1</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="n">k2</span><span class="p">[</span><span class="n">n</span><span class="p">])</span><span class="o">-</span><span class="n">Y</span><span class="p">(</span><span class="n">i1</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="n">j1</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="n">k1</span><span class="p">[</span><span class="n">n</span><span class="p">]))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> 
                    <span class="p">(</span><span class="n">Z</span><span class="p">(</span><span class="n">i1</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="n">j1</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="n">k2</span><span class="p">[</span><span class="n">n</span><span class="p">])</span><span class="o">-</span><span class="n">Z</span><span class="p">(</span><span class="n">i1</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="n">j1</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="n">k1</span><span class="p">[</span><span class="n">n</span><span class="p">]))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="p">)</span>
    <span class="n">aspect</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">ds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">aspect</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">ds</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="n">ds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">elif</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">aspect</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">ds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">ds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">elif</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">aspect</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ds</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">ds</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">aspect</span><span class="p">)</span> </div>



<span class="k">def</span><span class="w"> </span><span class="nf">__step_search</span><span class="p">(</span><span class="n">total_cells</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span><span class="n">greatest_common_divisor</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span><span class="n">ncells_per_block</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span><span class="n">denominator</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span><span class="n">direction</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s1">&#39;forward&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Searches for the right step size that leads to block splits with the same greatest common divisor. Same greatest common denominator means you will always have the same multi-grid when you solve. </span>

<span class="sd">    Args:</span>
<span class="sd">        total_cells (int): [description]</span>
<span class="sd">        greatest_common_divisor (int): [description]</span>
<span class="sd">        ncells_per_block (int): [description]</span>
<span class="sd">        denominator (float): If the direction is &quot;i&quot; then denominator is JMAX*KMAX</span>
<span class="sd">        direction (str, optional): &#39;forward&#39; or &#39;backward&#39; This chooses to increment step direction by +1 or -1. Defaults to &#39;forward&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        [type]: [description]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">step_size</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">ncells_per_block</span><span class="o">/</span><span class="n">denominator</span><span class="p">)</span>     <span class="c1"># initial Guess</span>
    <span class="n">initial_guess</span> <span class="o">=</span> <span class="n">step_size</span>
    <span class="n">Number_of_Cells_Remaining</span> <span class="o">=</span> <span class="n">total_cells</span> <span class="o">%</span> <span class="p">(</span><span class="n">step_size</span><span class="o">*</span><span class="n">denominator</span><span class="p">)</span>
    <span class="n">IJK_MAX_Remainder</span> <span class="o">=</span> <span class="n">Number_of_Cells_Remaining</span><span class="o">/</span><span class="n">denominator</span>
    <span class="n">increment</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">direction</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;forward&#39;</span><span class="p">:</span>
        <span class="n">increment</span><span class="o">=</span><span class="mi">1</span> 
    <span class="k">while</span> <span class="p">(</span> <span class="p">(</span><span class="n">step_size</span> <span class="o">%</span><span class="n">greatest_common_divisor</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> 
            <span class="p">((</span><span class="n">IJK_MAX_Remainder</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="n">greatest_common_divisor</span> <span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> 
            <span class="n">step_size</span><span class="o">&gt;</span><span class="n">initial_guess</span><span class="o">/</span><span class="mi">2</span> <span class="ow">and</span> 
            <span class="n">step_size</span><span class="o">&lt;</span><span class="n">initial_guess</span><span class="o">*</span><span class="mf">1.5</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">step_size</span> <span class="o">%</span><span class="n">greatest_common_divisor</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">IJK_MAX_Remainder</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="n">greatest_common_divisor</span> <span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">step_size</span><span class="o">+=</span><span class="n">increment</span> 
        <span class="n">Number_of_Cells_Remaining</span> <span class="o">=</span> <span class="n">total_cells</span> <span class="o">%</span> <span class="p">((</span><span class="n">step_size</span><span class="p">)</span><span class="o">*</span><span class="n">denominator</span><span class="p">)</span>
        <span class="n">IJK_MAX_Remainder</span> <span class="o">=</span> <span class="n">Number_of_Cells_Remaining</span><span class="o">/</span><span class="n">denominator</span>
    
    <span class="k">if</span> <span class="n">step_size</span> <span class="o">%</span><span class="n">greatest_common_divisor</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>             <span class="c1"># This checks if each of the split blocks is divisible by gcd</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">IJK_MAX_Remainder</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="n">greatest_common_divisor</span> <span class="o">!=</span><span class="mi">0</span><span class="p">:</span>   <span class="c1">#  This checks the remaining/final block to see if it is divisible by gcd</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">step_size</span>

<div class="viewcode-block" id="split_blocks">
<a class="viewcode-back" href="../../modules/split_block.html#plot3d.split_block.split_blocks">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">split_blocks</span><span class="p">(</span><span class="n">blocks</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="n">Block</span><span class="p">],</span> <span class="n">ncells_per_block</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span><span class="n">direction</span><span class="p">:</span><span class="n">Direction</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Split blocks is used to divide an array of blocks based on number of cells per block. This code maintains the greatest common denominator of the parent block. Number of cells per block is simply an estimate of how many you want. The actual number will change to meet the greatest common denominator (GCD). GCD of 4 means multigrid of 3 e.g. grid/4 (coarse), 2 (fine), and 1 (finest). If a direction is not specified then for each block the longest index either i,j, or k is used. </span>
<span class="sd">    </span>

<span class="sd">        Wisdom from Dave Rigby:</span>
<span class="sd">            For example, for radial equilibrium we must integrate across the span.  Some codes (GlennHT used to) would want a single block across the entire span.  In that case you would want some additional control.</span>
<span class="sd"> </span>
<span class="sd">            Another example might be if you would like a block to include the entire boundary layer.  In that case you might introduce an aspect ratio control.</span>
<span class="sd">            </span>
<span class="sd">    Args:</span>
<span class="sd">        blocks (List[Block]): List of blocks</span>
<span class="sd">        ncells_per_block (int): number of cells desired per block </span>
<span class="sd">        direction (Direction): direction to split the blocks in. Direction.(i,j,k). Defaults to None. None means it will pick the direction for you based on which is greater IMAX, JMAX, or KMAX</span>

<span class="sd">    Returns:</span>
<span class="sd">        Blocks (List[Block]): list of blocks split in the specified direction </span>
<span class="sd">    &quot;&quot;&quot;</span> 
    
    <span class="n">direction_to_use</span> <span class="o">=</span> <span class="n">direction</span> <span class="c1"># store the user input variable </span>
    
    <span class="n">new_blocks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">block_indx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">blocks</span><span class="p">)):</span>
        <span class="n">block</span> <span class="o">=</span> <span class="n">blocks</span><span class="p">[</span><span class="n">block_indx</span><span class="p">]</span>
        <span class="n">total_cells</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">IMAX</span><span class="o">*</span><span class="n">block</span><span class="o">.</span><span class="n">JMAX</span><span class="o">*</span><span class="n">block</span><span class="o">.</span><span class="n">KMAX</span>

        <span class="k">if</span> <span class="n">direction</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span> 
            <span class="n">indx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">block</span><span class="o">.</span><span class="n">IMAX</span><span class="p">,</span><span class="n">block</span><span class="o">.</span><span class="n">JMAX</span><span class="p">,</span><span class="n">block</span><span class="o">.</span><span class="n">KMAX</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">indx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">direction_to_use</span><span class="o">=</span><span class="n">Direction</span><span class="o">.</span><span class="n">i</span>
            <span class="k">elif</span> <span class="n">indx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">direction_to_use</span><span class="o">=</span><span class="n">Direction</span><span class="o">.</span><span class="n">j</span>
            <span class="k">elif</span> <span class="n">indx</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">direction_to_use</span><span class="o">=</span><span class="n">Direction</span><span class="o">.</span><span class="n">k</span>

        <span class="k">if</span> <span class="n">total_cells</span><span class="o">&gt;</span><span class="n">ncells_per_block</span><span class="p">:</span>
            <span class="c1"># Use greatest common divsor to maintain multi-grid so say the entire block is divisible by 4 then we want to maintain than for all the splits! </span>
            <span class="n">greatest_common_divisor</span> <span class="o">=</span><span class="n">gcd</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">IMAX</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">gcd</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">JMAX</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">block</span><span class="o">.</span><span class="n">KMAX</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># Gets the maximum number of partitions that we can make for this given block</span>
            <span class="k">if</span> <span class="n">direction_to_use</span> <span class="o">==</span> <span class="n">Direction</span><span class="o">.</span><span class="n">i</span><span class="p">:</span> 
                
                <span class="c1"># In order to get close to the number of cells per block, we need to control how many steps of the greatest_common_divisor to advance so for example if you have a multigrid mesh that has gcd of 16 (fine) =&gt; 8 (coarse) =&gt; 4 (coarser) =&gt; 2 (coarsest) and you want 400K cells per block then JMAX*KMAX*gcd*some_factor has to be close to 400K cells</span>
                <span class="n">denominator</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">JMAX</span><span class="o">*</span><span class="n">block</span><span class="o">.</span><span class="n">KMAX</span>
                <span class="n">step_size</span> <span class="o">=</span> <span class="n">__step_search</span><span class="p">(</span><span class="n">total_cells</span><span class="p">,</span><span class="n">greatest_common_divisor</span><span class="p">,</span><span class="n">ncells_per_block</span><span class="p">,</span><span class="n">denominator</span><span class="p">,</span><span class="n">direction</span><span class="o">=</span><span class="s1">&#39;backward&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">step_size</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">step_size</span> <span class="o">=</span> <span class="n">__step_search</span><span class="p">(</span><span class="n">total_cells</span><span class="p">,</span><span class="n">greatest_common_divisor</span><span class="p">,</span><span class="n">ncells_per_block</span><span class="p">,</span><span class="n">denominator</span><span class="p">,</span><span class="n">direction</span><span class="o">=</span><span class="s1">&#39;forward&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">step_size</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">assert</span><span class="p">(</span><span class="s1">&#39;no valid step size found, do you have multi-block? gcd &gt; 1&#39;</span><span class="p">)</span>
                <span class="c1"># step_size-1 is the IMAX of the sub_blocks e.g. 0 to 92 this shows IMAX=93, (93-1) % 4 = 0 (good)</span>
                
                <span class="n">iprev</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">step_size</span><span class="p">,</span><span class="n">block</span><span class="o">.</span><span class="n">IMAX</span><span class="p">,</span><span class="n">step_size</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">block</span><span class="o">.</span><span class="n">IMAX</span><span class="p">:</span>
                        <span class="k">break</span>

                    <span class="n">X</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">iprev</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,:,:]</span>      <span class="c1"># New X, Y, Z splits </span>
                    <span class="n">Y</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="n">iprev</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,:,:]</span>      <span class="c1"># This indexes to iprev:i so if iprev=2 and i = 10 it will go from 2 to 9</span>
                    <span class="n">Z</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">Z</span><span class="p">[</span><span class="n">iprev</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,:,:]</span>
                    <span class="n">iprev</span><span class="o">=</span><span class="n">i</span>                     <span class="c1"># Blocks have to share the same face, Pick the previous face</span>
                    <span class="n">new_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Block</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span><span class="p">))</span>

                <span class="c1"># Check for remainder</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">block</span><span class="o">.</span><span class="n">IMAX</span><span class="p">:</span>
                    <span class="c1"># Add remainder to last block</span>
                    <span class="n">X</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">:,:,:]</span> <span class="c1"># New X, Y, Z splits </span>
                    <span class="n">Y</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="n">i</span><span class="p">:,:,:]</span>
                    <span class="n">Z</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">Z</span><span class="p">[</span><span class="n">i</span><span class="p">:,:,:]</span>
                    <span class="n">new_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Block</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span><span class="p">))</span>
                
            <span class="k">elif</span> <span class="n">direction_to_use</span> <span class="o">==</span> <span class="n">Direction</span><span class="o">.</span><span class="n">j</span><span class="p">:</span>                
                <span class="n">denominator</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">IMAX</span><span class="o">*</span><span class="n">block</span><span class="o">.</span><span class="n">KMAX</span>
                <span class="n">step_size</span> <span class="o">=</span> <span class="n">__step_search</span><span class="p">(</span><span class="n">total_cells</span><span class="p">,</span><span class="n">greatest_common_divisor</span><span class="p">,</span><span class="n">ncells_per_block</span><span class="p">,</span><span class="n">denominator</span><span class="p">,</span><span class="n">direction</span><span class="o">=</span><span class="s1">&#39;backward&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">step_size</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">step_size</span> <span class="o">=</span> <span class="n">__step_search</span><span class="p">(</span><span class="n">total_cells</span><span class="p">,</span><span class="n">greatest_common_divisor</span><span class="p">,</span><span class="n">ncells_per_block</span><span class="p">,</span><span class="n">denominator</span><span class="p">,</span><span class="n">direction</span><span class="o">=</span><span class="s1">&#39;forward&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">step_size</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">assert</span><span class="p">(</span><span class="s1">&#39;no valid step size found, do you have multi-block? gcd &gt; 1&#39;</span><span class="p">)</span>
                <span class="n">jprev</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">step_size</span><span class="p">,</span><span class="n">block</span><span class="o">.</span><span class="n">JMAX</span><span class="p">,</span><span class="n">step_size</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">block</span><span class="o">.</span><span class="n">IMAX</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">X</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">X</span><span class="p">[:,</span><span class="n">jprev</span><span class="p">:</span><span class="n">j</span><span class="p">,:]</span>      <span class="c1"># New X, Y, Z splits </span>
                    <span class="n">Y</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">Y</span><span class="p">[:,</span><span class="n">jprev</span><span class="p">:</span><span class="n">j</span><span class="p">,:]</span>
                    <span class="n">Z</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">Z</span><span class="p">[:,</span><span class="n">jprev</span><span class="p">:</span><span class="n">j</span><span class="p">,:]</span>
                    <span class="n">jprev</span><span class="o">=</span><span class="n">j</span>
                    <span class="n">new_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Block</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span><span class="p">))</span>

                <span class="c1"># Check for remainder</span>
                <span class="k">if</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">block</span><span class="o">.</span><span class="n">JMAX</span><span class="p">:</span>
                    <span class="c1"># Add remainder to last block</span>
                    <span class="n">X</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">X</span><span class="p">[:,</span><span class="n">j</span><span class="p">:,:]</span> <span class="c1"># New X, Y, Z splits </span>
                    <span class="n">Y</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">Y</span><span class="p">[:,</span><span class="n">j</span><span class="p">:,:]</span>
                    <span class="n">Z</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">Z</span><span class="p">[:,</span><span class="n">j</span><span class="p">:,:]</span>
                    <span class="n">new_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Block</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">denominator</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">IMAX</span><span class="o">*</span><span class="n">block</span><span class="o">.</span><span class="n">JMAX</span>
                <span class="n">step_size</span> <span class="o">=</span> <span class="n">__step_search</span><span class="p">(</span><span class="n">total_cells</span><span class="p">,</span><span class="n">greatest_common_divisor</span><span class="p">,</span><span class="n">ncells_per_block</span><span class="p">,</span><span class="n">denominator</span><span class="p">,</span><span class="n">direction</span><span class="o">=</span><span class="s1">&#39;backward&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">step_size</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">step_size</span> <span class="o">=</span> <span class="n">__step_search</span><span class="p">(</span><span class="n">total_cells</span><span class="p">,</span><span class="n">greatest_common_divisor</span><span class="p">,</span><span class="n">ncells_per_block</span><span class="p">,</span><span class="n">denominator</span><span class="p">,</span><span class="n">direction</span><span class="o">=</span><span class="s1">&#39;forward&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">step_size</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">assert</span><span class="p">(</span><span class="s1">&#39;no valid step size found, do you have multi-block? gcd &gt; 1&#39;</span><span class="p">)</span>
                <span class="n">kprev</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">step_size</span><span class="p">,</span><span class="n">block</span><span class="o">.</span><span class="n">KMAX</span><span class="p">,</span><span class="n">step_size</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">block</span><span class="o">.</span><span class="n">KMAX</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">X</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">X</span><span class="p">[:,:,</span><span class="n">kprev</span><span class="p">:</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>     <span class="c1"># New X, Y, Z splits </span>
                    <span class="n">Y</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">Y</span><span class="p">[:,:,</span><span class="n">kprev</span><span class="p">:</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">Z</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">Z</span><span class="p">[:,:,</span><span class="n">kprev</span><span class="p">:</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">kprev</span><span class="o">=</span><span class="n">k</span>
                    <span class="n">new_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Block</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span><span class="p">))</span>

                <span class="c1"># Check for remainder</span>
                <span class="k">if</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">block</span><span class="o">.</span><span class="n">KMAX</span><span class="p">:</span>
                   <span class="c1"># Add remainder to last block</span>
                    <span class="n">X</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">X</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">:]</span> <span class="c1"># New X, Y, Z splits </span>
                    <span class="n">Y</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">Y</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">:]</span>
                    <span class="n">Z</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">Z</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">:]</span>                    
                    <span class="n">new_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Block</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span><span class="p">))</span> <span class="c1"># replace it </span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_blocks</span></div>


        
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Plot3D 1.6.8 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">plot3d.split_block</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2025, Paht Juangphanich.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.4.7.
    </div>
  </body>
</html>